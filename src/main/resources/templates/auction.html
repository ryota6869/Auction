<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.springframework.org/schema/security">

<head>
  <meta charset="UTF-8">
  <title>Auction</title>
  <script>
    window.onload = function () {
      var sse = new EventSource('/auction/async');
      sse.onmessage = function (event) {
        console.log("sse.onmessage")
        console.log(event.data);
        var auctionInfos = JSON.parse(event.data);//JSONオブジェクトとしてparse
        var auctions_table = "";
        // DBに残っているフルーツのリストがJSONオブジェクトとして得られるので，htmlを作成し，tbodyの中身毎入れ替える
        for (var i = 0; i < auctionInfos.length; i++) {
          var bgn_tr = "<tr>";
          var end_tr = "</tr>";
          var idx = "<td>" + i + "</td>";
          var item_name = "<td>" + auctionInfos[i].itemName + "</td>";
          var sellerName = "<td>" + auctionInfos[i].sellerName + "</td>";
          var maxBid = "<td>" + auctionInfos[i].maxBid + "</td>";
          var date = "<td>" + auctionInfos[i].date + "</td>";
          var f_proc = "<td>"
            + "<form method='post'>"
            +"<input type = 'number' name = 'bid' />"
            +"<input type='hidden' name='auctionId' th:value='"
            + auctionInfos[i].id
            + "'>"
            +"<input type='hidden' name='userId' th:value='"
            + auctionInfos[i].bidderId
            + "'>"
            + "<input type='hidden' name='role' th:value='user'><input type='submit' value='入札' formaction='/auction/bid'></form>"
            + "</td>"
          auctions_table = auctions_table + bgn_tr + idx + item_name + sellerName + maxBid + date + f_proc + end_tr;
        }
        console.log(auctions_table);
        var tbody = document.getElementById("auctions_list_user");
        tbody.innerHTML = auctions_table;//idがfruits_listのtbodyのHTMLを差し替える

      }
    }
  </script>
</head>

<body>
  <a href="/home">もどる</a>
  <div>
    <table border="1">
      <thead>
        <th>ID</th>
        <th>アイテム名</th>
        <th>出品者</th>
        <th>最高入札額</th>
        <th>入札期限</th>
        <th>入札</th>
      </thead>
      <tbody id="auctions_list_user" sec:authorize="hasRole('ROLE_USER')">
        <span th:if="${auctionInfos}">
          <tr th:each="info, stat:${auctionInfos}">
            <td>[[${info.id}]]</td>
            <td>[[${info.itemName}]]</td>
            <td>[[${info.sellerName}]]</td>
            <td>[[${info.maxBid}]]</td>
            <td>[[${info.date}]]</td>
            <td>
              <form method="post">
                <input type="number" name="bid" />
                <input type="hidden" name="auctionId" th:value="${info.id}">
                <input type="hidden" name="userId" th:value="${userId}">
                <input type="hidden" name="role" th:value="user">
                <input type="submit" value="入札" formaction="/auction/bid">
              </form>
            </td>
          </tr>
        </span>
      </tbody>
      <tbody sec:authorize="hasRole('ROLE_ADMIN')">
        <span th:if="${auctionInfos}">
          <tr th:each="info, stat:${auctionInfos}">
            <td>[[${info.id}]]</td>
            <td>[[${info.itemName}]]</td>
            <td>[[${info.sellerName}]]</td>
            <td>[[${info.maxBid}]]</td>
            <td>[[${info.date}]]</td>
            <td>
              <form method="post">
                <input type="number" name="bid" />
                <input type="hidden" name="auctionId" th:value="${info.id}">
                <input type="hidden" name="userId" th:value="${userId}">
                <input type="hidden" name="role" th:value="admin">
                <input type="submit" value="入札" formaction="/auction/bid">
              </form>
            </td>
          </tr>
        </span>
      </tbody>
    </table>
  </div>

</body>

</html>
